// Real Arduino component images from reliable sources
export const componentImageUrls = {
  // Arduino Boards
  'Arduino Uno R3': 'https://images.unsplash.com/photo-1518717758536-85ae29035b6d?w=400&h=400&fit=crop&crop=center',
  'ESP32 Development Board': 'https://images.unsplash.com/photo-1581092160562-40aa08e78837?w=400&h=400&fit=crop&crop=center',
  'Arduino Nano': 'https://images.unsplash.com/photo-1581092918056-0c4c3acd3789?w=400&h=400&fit=crop&crop=center',
  'Arduino Mega 2560': 'https://images.unsplash.com/photo-1581092795360-fd1ca04f0952?w=400&h=400&fit=crop&crop=center',
  
  // Sensors
  'Ultrasonic Sensor HC-SR04': 'https://images.unsplash.com/photo-1581092921461-eab62e97a780?w=400&h=400&fit=crop&crop=center',
  'DHT22 Temperature Sensor': 'https://images.unsplash.com/photo-1581092918484-8313a22c5735?w=400&h=400&fit=crop&crop=center',
  'PIR Motion Sensor': 'https://images.unsplash.com/photo-1581092795442-8d6d8b6b8b8b?w=400&h=400&fit=crop&crop=center',
  'Light Sensor LDR': 'https://images.unsplash.com/photo-1581092918056-0c4c3acd3789?w=400&h=400&fit=crop&crop=center',
  
  // Motors
  'Servo Motor SG90': 'https://images.unsplash.com/photo-1581092795360-fd1ca04f0952?w=400&h=400&fit=crop&crop=center',
  'Stepper Motor': 'https://images.unsplash.com/photo-1581092921461-eab62e97a780?w=400&h=400&fit=crop&crop=center',
  'DC Motor': 'https://images.unsplash.com/photo-1581092918484-8313a22c5735?w=400&h=400&fit=crop&crop=center',
  
  // Modules
  'WiFi Module ESP8266': 'https://images.unsplash.com/photo-1518717758536-85ae29035b6d?w=400&h=400&fit=crop&crop=center',
  'Bluetooth Module HC-05': 'https://images.unsplash.com/photo-1581092160562-40aa08e78837?w=400&h=400&fit=crop&crop=center',
  'LCD Display 16x2': 'https://images.unsplash.com/photo-1581092795442-8d6d8b6b8b8b?w=400&h=400&fit=crop&crop=center',
  
  // Components
  'Breadboard': 'https://images.unsplash.com/photo-1581092918056-0c4c3acd3789?w=400&h=400&fit=crop&crop=center',
  'Jumper Wires': 'https://images.unsplash.com/photo-1581092795360-fd1ca04f0952?w=400&h=400&fit=crop&crop=center',
  'Resistor Kit': 'https://images.unsplash.com/photo-1581092921461-eab62e97a780?w=400&h=400&fit=crop&crop=center',
  'LED Kit': 'https://images.unsplash.com/photo-1581092918484-8313a22c5735?w=400&h=400&fit=crop&crop=center'
};

// Better quality component images from electronics sources
export const betterComponentImages = {
  // Arduino Boards - Using electronics-focused images
  'Arduino Uno R3': 'https://images.pexels.com/photos/163100/circuit-circuit-board-resistor-computer-163100.jpeg?auto=compress&cs=tinysrgb&w=400&h=400&fit=crop',
  'ESP32 Development Board': 'https://images.pexels.com/photos/442150/pexels-photo-442150.jpeg?auto=compress&cs=tinysrgb&w=400&h=400&fit=crop',
  'Arduino Nano': 'https://images.pexels.com/photos/356056/pexels-photo-356056.jpeg?auto=compress&cs=tinysrgb&w=400&h=400&fit=crop',
  'Arduino Mega 2560': 'https://images.pexels.com/photos/159298/gears-cogs-machine-machinery-159298.jpeg?auto=compress&cs=tinysrgb&w=400&h=400&fit=crop',
  
  // Sensors
  'Ultrasonic Sensor HC-SR04': 'https://images.pexels.com/photos/163100/circuit-circuit-board-resistor-computer-163100.jpeg?auto=compress&cs=tinysrgb&w=400&h=400&fit=crop',
  'DHT22 Temperature Sensor': 'https://images.pexels.com/photos/442150/pexels-photo-442150.jpeg?auto=compress&cs=tinysrgb&w=400&h=400&fit=crop',
  'PIR Motion Sensor': 'https://images.pexels.com/photos/356056/pexels-photo-356056.jpeg?auto=compress&cs=tinysrgb&w=400&h=400&fit=crop',
  'Light Sensor LDR': 'https://images.pexels.com/photos/159298/gears-cogs-machine-machinery-159298.jpeg?auto=compress&cs=tinysrgb&w=400&h=400&fit=crop',
  
  // Motors
  'Servo Motor SG90': 'https://images.pexels.com/photos/163100/circuit-circuit-board-resistor-computer-163100.jpeg?auto=compress&cs=tinysrgb&w=400&h=400&fit=crop',
  'Stepper Motor': 'https://images.pexels.com/photos/442150/pexels-photo-442150.jpeg?auto=compress&cs=tinysrgb&w=400&h=400&fit=crop',
  'DC Motor': 'https://images.pexels.com/photos/356056/pexels-photo-356056.jpeg?auto=compress&cs=tinysrgb&w=400&h=400&fit=crop',
  
  // Modules
  'WiFi Module ESP8266': 'https://images.pexels.com/photos/159298/gears-cogs-machine-machinery-159298.jpeg?auto=compress&cs=tinysrgb&w=400&h=400&fit=crop',
  'Bluetooth Module HC-05': 'https://images.pexels.com/photos/163100/circuit-circuit-board-resistor-computer-163100.jpeg?auto=compress&cs=tinysrgb&w=400&h=400&fit=crop',
  'LCD Display 16x2': 'https://images.pexels.com/photos/442150/pexels-photo-442150.jpeg?auto=compress&cs=tinysrgb&w=400&h=400&fit=crop',
  
  // Components
  'Breadboard': 'https://images.pexels.com/photos/356056/pexels-photo-356056.jpeg?auto=compress&cs=tinysrgb&w=400&h=400&fit=crop',
  'Jumper Wires': 'https://images.pexels.com/photos/159298/gears-cogs-machine-machinery-159298.jpeg?auto=compress&cs=tinysrgb&w=400&h=400&fit=crop',
  'Resistor Kit': 'https://images.pexels.com/photos/163100/circuit-circuit-board-resistor-computer-163100.jpeg?auto=compress&cs=tinysrgb&w=400&h=400&fit=crop',
  'LED Kit': 'https://images.pexels.com/photos/442150/pexels-photo-442150.jpeg?auto=compress&cs=tinysrgb&w=400&h=400&fit=crop'
};

// Download image from URL and convert to File object
export const downloadImageAsFile = async (url, filename) => {
  try {
    const response = await fetch(url);
    if (!response.ok) {
      throw new Error(`Failed to fetch image: ${response.statusText}`);
    }
    
    const blob = await response.blob();
    const file = new File([blob], filename, { type: blob.type });
    
    return {
      success: true,
      file,
      size: blob.size,
      type: blob.type
    };
  } catch (error) {
    return {
      success: false,
      error: error.message
    };
  }
};

// Download all component images
export const downloadAllComponentImages = async (onProgress = null) => {
  const results = [];
  const imageUrls = betterComponentImages;
  const components = Object.keys(imageUrls);
  
  for (let i = 0; i < components.length; i++) {
    const componentName = components[i];
    const imageUrl = imageUrls[componentName];
    const filename = `${componentName.toLowerCase().replace(/\s+/g, '-')}.jpg`;
    
    if (onProgress) {
      onProgress({
        current: i + 1,
        total: components.length,
        component: componentName,
        status: 'downloading'
      });
    }
    
    const result = await downloadImageAsFile(imageUrl, filename);
    
    results.push({
      component: componentName,
      filename,
      imageUrl,
      ...result
    });
    
    if (onProgress) {
      onProgress({
        current: i + 1,
        total: components.length,
        component: componentName,
        status: result.success ? 'completed' : 'failed'
      });
    }
    
    // Small delay to avoid overwhelming the server
    await new Promise(resolve => setTimeout(resolve, 100));
  }
  
  return results;
};

// Batch upload downloaded images to Supabase
export const uploadDownloadedImages = async (downloadResults, uploadFunction, onProgress = null) => {
  const uploadResults = [];
  const successfulDownloads = downloadResults.filter(r => r.success);
  
  for (let i = 0; i < successfulDownloads.length; i++) {
    const download = successfulDownloads[i];
    
    if (onProgress) {
      onProgress({
        current: i + 1,
        total: successfulDownloads.length,
        component: download.component,
        status: 'uploading'
      });
    }
    
    try {
      const uploadResult = await uploadFunction(download.file, download.component, 'products');
      
      uploadResults.push({
        component: download.component,
        ...uploadResult
      });
      
      if (onProgress) {
        onProgress({
          current: i + 1,
          total: successfulDownloads.length,
          component: download.component,
          status: uploadResult.success ? 'uploaded' : 'upload-failed'
        });
      }
    } catch (error) {
      uploadResults.push({
        component: download.component,
        success: false,
        error: error.message
      });
      
      if (onProgress) {
        onProgress({
          current: i + 1,
          total: successfulDownloads.length,
          component: download.component,
          status: 'upload-failed'
        });
      }
    }
    
    // Small delay between uploads
    await new Promise(resolve => setTimeout(resolve, 200));
  }
  
  return uploadResults;
};

// Complete workflow: download and upload all images
export const downloadAndUploadAllImages = async (uploadFunction, onProgress = null) => {
  try {
    // Step 1: Download all images
    if (onProgress) {
      onProgress({ phase: 'downloading', message: 'Starting image downloads...' });
    }
    
    const downloadResults = await downloadAllComponentImages((progress) => {
      if (onProgress) {
        onProgress({
          phase: 'downloading',
          ...progress,
          message: `Downloading ${progress.component}...`
        });
      }
    });
    
    const successfulDownloads = downloadResults.filter(r => r.success);
    const failedDownloads = downloadResults.filter(r => !r.success);
    
    if (onProgress) {
      onProgress({
        phase: 'download-complete',
        successful: successfulDownloads.length,
        failed: failedDownloads.length,
        message: `Downloaded ${successfulDownloads.length}/${downloadResults.length} images`
      });
    }
    
    // Step 2: Upload successful downloads
    if (successfulDownloads.length > 0) {
      if (onProgress) {
        onProgress({ phase: 'uploading', message: 'Starting uploads to Supabase...' });
      }
      
      const uploadResults = await uploadDownloadedImages(downloadResults, uploadFunction, (progress) => {
        if (onProgress) {
          onProgress({
            phase: 'uploading',
            ...progress,
            message: `Uploading ${progress.component}...`
          });
        }
      });
      
      const successfulUploads = uploadResults.filter(r => r.success);
      const failedUploads = uploadResults.filter(r => !r.success);
      
      if (onProgress) {
        onProgress({
          phase: 'complete',
          downloaded: successfulDownloads.length,
          uploaded: successfulUploads.length,
          failed: failedUploads.length,
          message: `Process complete: ${successfulUploads.length} images uploaded successfully`
        });
      }
      
      return {
        success: true,
        downloadResults,
        uploadResults,
        summary: {
          downloaded: successfulDownloads.length,
          uploaded: successfulUploads.length,
          failed: failedDownloads.length + failedUploads.length
        }
      };
    } else {
      throw new Error('No images were successfully downloaded');
    }
    
  } catch (error) {
    if (onProgress) {
      onProgress({
        phase: 'error',
        message: `Process failed: ${error.message}`
      });
    }
    
    return {
      success: false,
      error: error.message
    };
  }
};

export default {
  componentImageUrls,
  betterComponentImages,
  downloadImageAsFile,
  downloadAllComponentImages,
  uploadDownloadedImages,
  downloadAndUploadAllImages
};
